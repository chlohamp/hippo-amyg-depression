---
title: "PLSC Stage 2: Task Connectivity ↔ Socioenvironment–Depression Latent Dimensions"
author: "Chloe Hampson"
date: "`r Sys.Date()`"
output:
  html_document:
    fontsize: 9pt
    theme: united
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
---

# Overview

This document performs **Stage 2** of the analysis:

1. Load **PLSC latent scores** from Stage 1:
   - `lx` = socioenvironment LV scores
   - `ly` = depression LV scores
2. Residualize **task connectivity** (brain_df) using the same covariates as Stage 1
3. Relate task connectivity to PLSC dimensions via:
   - **Correlation**: brain ↔ `lx` and brain ↔ `ly`
   - **Moderation**: `ly_dim ~ lx_dim * brain_feature` (tests whether brain modifies the LV association)

---

```{r}
# ---- KNIT-SAFE SETUP ----
knitr::opts_knit$set(root.dir = "/Users/chloehampson/Desktop/hippo-amyg-depression")

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

options(stringsAsFactors = FALSE)
set.seed(1)
```

```{r}
library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
library(corrplot)
library(broom)
library(knitr)
library(kableExtra)

```

```{r}
data_dir <- "derivatives"
fig_dir  <- file.path(data_dir, "figures_stage2")
out_dir  <- file.path(data_dir, "stage2_outputs")

if (!dir.exists(fig_dir)) dir.create(fig_dir, recursive = TRUE)
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

covar_df <- readr::read_csv(file.path(data_dir, "demographics_clean.csv"))
brain_df <- readr::read_csv(file.path(data_dir, "task-FC-stage-2_clean.csv"))

cat("Rows x Cols\n")
cat("covar_df:", nrow(covar_df), "x", ncol(covar_df), "\n")
cat("brain_df:", nrow(brain_df), "x", ncol(brain_df), "\n")
```

```{r}
# Preferred clean filenames
lx_path_clean <- file.path(data_dir, "plsc_LV_scores_socioenv.csv")
ly_path_clean <- file.path(data_dir, "plsc_LV_scores_depression.csv")

# Fallback to your current filenames if you haven't renamed
lx_path_old <- file.path(data_dir, "rniXrsfc_lx-base.csv")
ly_path_old <- file.path(data_dir, "rniXrsfc_ly-base.csv")

lx_path <- if (file.exists(lx_path_clean)) lx_path_clean else lx_path_old
ly_path <- if (file.exists(ly_path_clean)) ly_path_clean else ly_path_old

stopifnot(file.exists(lx_path), file.exists(ly_path))

lx <- read.csv(lx_path, row.names = 1)
ly <- read.csv(ly_path, row.names = 1)

cat("Loaded LV scores:\n")
cat("lx path:", lx_path, " | dim:", dim(lx), "\n")
cat("ly path:", ly_path, " | dim:", dim(ly), "\n")
```

```{r}
id_col <- "participant_id"

stopifnot(id_col %in% names(covar_df))
stopifnot(id_col %in% names(brain_df))

# Make rownames consistent for merges
covar_df <- covar_df %>% distinct(.data[[id_col]], .keep_all = TRUE)
brain_df <- brain_df %>% distinct(.data[[id_col]], .keep_all = TRUE)

# LV score rownames are IDs
lv_ids <- rownames(lx)

common_ids <- Reduce(intersect, list(
  covar_df[[id_col]],
  brain_df[[id_col]],
  lv_ids
))

cat("N common subjects across covar, brain, and LV scores:", length(common_ids), "\n")

covar_sub <- covar_df %>% filter(.data[[id_col]] %in% common_ids)
brain_sub <- brain_df %>% filter(.data[[id_col]] %in% common_ids)

# Match ordering to LV matrices
covar_sub <- covar_sub %>% arrange(match(.data[[id_col]], common_ids))
brain_sub <- brain_sub %>% arrange(match(.data[[id_col]], common_ids))

lx_sub <- lx[common_ids, , drop = FALSE]
ly_sub <- ly[common_ids, , drop = FALSE]

stopifnot(all(covar_sub[[id_col]] == common_ids))
stopifnot(all(brain_sub[[id_col]] == common_ids))

```

```{r}
# ---- covariate columns used in Stage 1 ----
covar_terms <- c(
  "ab_p_demo_age",
  "ab_g_stc__cohort_sex",
  "ab_g_stc__cohort_ethnrace__meim",
  "ab_g_stc__cohort_race__nih",
  "ab_g_dyn__design_site",
  "mr_y_adm__info__dev_manufact",
  "ab_g_stc__design_id__fam"
)

missing_terms <- covar_terms[!covar_terms %in% names(covar_sub)]
if (length(missing_terms) > 0) {
  cat("WARNING: Missing covariate columns in covar_df:\n")
  print(missing_terms)
  cat("Update covar_terms to match your demographics_clean.csv.\n")
  stop("Missing covariates: cannot residualize brain features safely.")
}

# Brain feature matrix: drop ID column
brain_mat <- brain_sub %>%
  select(-all_of(id_col)) %>%
  as.matrix()

# Build covariate dataframe for regression
covar_reg <- covar_sub %>%
  select(all_of(covar_terms)) %>%
  mutate(
    ab_g_stc__cohort_sex = as.factor(ab_g_stc__cohort_sex),
    ab_g_stc__cohort_ethnrace__meim = as.factor(ab_g_stc__cohort_ethnrace__meim),
    ab_g_stc__cohort_race__nih = as.factor(ab_g_stc__cohort_race__nih),
    ab_g_dyn__design_site = as.factor(ab_g_dyn__design_site),
    mr_y_adm__info__dev_manufact = as.factor(mr_y_adm__info__dev_manufact)
  )

# check factor levels in the complete-case regression sample


# Multivariate linear model: response is a matrix
# This yields residuals for each brain feature column
lm_brain <- lm(brain_mat ~ ., data = covar_reg, na.action = na.omit)
brain_resid <- as.data.frame(lm_brain$residuals)

cat("Residualized brain feature matrix:", dim(brain_resid), "\n")
```

```{r}
dims_to_test <- c(1, 2)

# basic checks
stopifnot(max(dims_to_test) <= ncol(lx_sub))
stopifnot(max(dims_to_test) <= ncol(ly_sub))
```


```{r}
cor_results <- list()

for (d in dims_to_test) {
  lx_vec <- lx_sub[, d]
  ly_vec <- ly_sub[, d]

  # Correlate each brain feature with lx and ly
  for (feat in names(brain_resid)) {
    x <- brain_resid[[feat]]

    c1 <- suppressWarnings(cor.test(x, lx_vec))
    c2 <- suppressWarnings(cor.test(x, ly_vec))

    cor_results[[length(cor_results) + 1]] <- tibble(
      dimension = d,
      brain_feature = feat,

      target = "lx_socioenv",
      r = unname(c1$estimate),
      p = c1$p.value
    )

    cor_results[[length(cor_results) + 1]] <- tibble(
      dimension = d,
      brain_feature = feat,

      target = "ly_depression",
      r = unname(c2$estimate),
      p = c2$p.value
    )
  }
}

cor_df <- bind_rows(cor_results) %>%
  mutate(p_fdr = p.adjust(p, method = "fdr")) %>%
  arrange(p_fdr)

write_csv(cor_df, file.path(out_dir, "stage2_brain_LV_correlations.csv"))

cat("Saved:", file.path(out_dir, "stage2_brain_LV_correlations.csv"), "\n")

# Show top results
cor_df %>%
  head(20) %>%
  kable() %>%
  kable_styling()
```

```{r}
# pick top N features by FDR
topN <- 30
top_feats <- cor_df %>%
  arrange(p_fdr) %>%
  distinct(brain_feature) %>%
  slice(1:topN) %>%
  pull(brain_feature)

heat_df <- cor_df %>%
  filter(brain_feature %in% top_feats) %>%
  mutate(lv = paste0(target, "_Dim", dimension)) %>%
  select(brain_feature, lv, r) %>%
  pivot_wider(names_from = lv, values_from = r)

mat <- heat_df %>% column_to_rownames("brain_feature") %>% as.matrix()

png(file.path(fig_dir, "BrainFeature_x_LV_correlation_heatmap.png"),
    width = 1600, height = 1200, res = 150)

corrplot(mat,
         is.corr = FALSE,
         method = "color",
         tl.cex = 0.6,
         tl.col = "black",
         cl.cex = 0.7,
         mar = c(0,0,2,0),
         title = paste0("Top ", topN, " Task-Connectivity Features vs LV Scores"))

dev.off()

cat("Saved heatmap to:", file.path(fig_dir, "BrainFeature_x_LV_correlation_heatmap.png"), "\n")
```

## Step 2B: Moderation Analysis

```{r}
mod_results <- list()

for (d in dims_to_test) {
  df_mod <- tibble(
    id = common_ids,
    lx = as.numeric(lx_sub[, d]),
    ly = as.numeric(ly_sub[, d])
  )

  for (feat in names(brain_resid)) {
    df_mod$brain <- as.numeric(brain_resid[[feat]])

    fit <- lm(ly ~ lx * brain, data = df_mod)

    tt <- broom::tidy(fit)

    # interaction row
    inter <- tt %>% filter(term == "lx:brain")

    mod_results[[length(mod_results) + 1]] <- tibble(
      dimension = d,
      brain_feature = feat,
      beta_interaction = inter$estimate,
      se_interaction = inter$std.error,
      t_interaction = inter$statistic,
      p_interaction = inter$p.value
    )
  }
}

mod_df <- bind_rows(mod_results) %>%
  mutate(p_fdr = p.adjust(p_interaction, method = "fdr")) %>%
  arrange(p_fdr)

write_csv(mod_df, file.path(out_dir, "stage2_moderation_lv_lx_by_brain.csv"))

cat("Saved:", file.path(out_dir, "stage2_moderation_lv_lx_by_brain.csv"), "\n")

mod_df %>%
  head(20) %>%
  kable() %>%
  kable_styling()
```

